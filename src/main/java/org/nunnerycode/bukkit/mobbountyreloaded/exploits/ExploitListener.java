package org.nunnerycode.bukkit.mobbountyreloaded.exploits;

import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.nunnerycode.bukkit.mobbountyreloaded.MobBountyReloadedPlugin;
import org.nunnerycode.bukkit.mobbountyreloaded.events.MobBountyReloadedRewardEvent;

import java.util.HashMap;
import java.util.Map;

public final class ExploitListener implements Listener {

  private MobBountyReloadedPlugin plugin;
  private Map<String, PlayerKillData> playerKillDataMap;

  public ExploitListener(MobBountyReloadedPlugin plugin) {
    this.plugin = plugin;
    playerKillDataMap = new HashMap<>();
  }

  @EventHandler
  public void onMobBountyReloadedRewardEvent(MobBountyReloadedRewardEvent event) {
    Player player = event.getPlayer();
    PlayerKillData playerKillData;
    if (playerKillDataMap.containsKey(player.getName())) {
      playerKillData = playerKillDataMap.get(player.getName());
    } else {
      playerKillData = new PlayerKillData();
    }
    if (plugin.getIvorySettings().getBoolean("exploits.depreciative-return.enabled", false)) {
      if (event.getEntity().getType() == playerKillData.getLastKillType()) {
        playerKillData.setLastKillPercentage(
            playerKillData.getLastKillPercentage() - plugin.getIvorySettings()
                .getDouble("exploits.depreciative-return.percentage", 0.1)
        );
        event.setAmount(event.getAmount() * playerKillData.getLastKillPercentage());
      } else {
        playerKillData.setLastKillPercentage(1.0);
        playerKillData.setLastKillType(event.getEntity().getType());
      }
    }

    playerKillDataMap.put(player.getName(), playerKillData);
  }

}
